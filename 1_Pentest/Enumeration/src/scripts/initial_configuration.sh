#!/bin/bash
set -e

# Reconfigure GitLab
sudo gitlab-ctl reconfigure

# Create a user with admin privileges
NEW_ADMIN_PASS='CYnFUPZ8v%X8iWzs'
sudo gitlab-rails runner "user = Users::CreateService.new( \
    nil, username: 'r.nomura', email: 'r.nomura@mirai-itsystems.local', \
    name: '野村 令', password: '$NEW_ADMIN_PASS', \
    password_confirmation: '$NEW_ADMIN_PASS', \
    organization_id: Organizations::Organization.first.id, \
    skip_confirmation: true).execute"
sudo gitlab-rails runner "user = User.find_by_username('r.nomura'); user.admin = true; user.save!"

# Change the root user's password
# NEW_ROOT_PASS="lT1xh7ee/xFUfvc"
# sudo gitlab-rails runner "user = User.find_by_username('root'); \
#     user.password = '$NEW_ROOT_PASS'; user.password_confirmation = '$NEW_ROOT_PASS'; user.save!"

# Delete the root user
sudo gitlab-rails runner "user = User.find_by_username('root'); user.destroy!"

# Create other users with non-admin privileges
C_SAKAMOTO_PASS='8iVhrFp%sCGLTa*7'
sudo gitlab-rails runner "user = Users::CreateService.new( \
    nil, username: 'c.sakamoto', email: 'c.sakamoto@mirai-itsystems.local', \
    name: '坂本 千果', password: '$C_SAKAMOTO_PASS', \
    password_confirmation: '$C_SAKAMOTO_PASS', \
    organization_id: Organizations::Organization.first.id, \
    skip_confirmation: true).execute"

M_YAMADA_PASS='C0yYiQa6%3PH8OvK'
sudo gitlab-rails runner "user = Users::CreateService.new( \
    nil, username: 'm.yamada', email: 'm.yamada@mirai-itsystems.local', \
    name: '山田 允', password: '$M_YAMADA_PASS', \
    password_confirmation: '$M_YAMADA_PASS', \
    organization_id: Organizations::Organization.first.id, \
    skip_confirmation: true).execute"

K_SAYAMA_PASS='46^zWCWk!crUOaOK'
sudo gitlab-rails runner "user = Users::CreateService.new( \
    nil, username: 'k.sayama', email: 'k.sayama@mirai-itsystems.local', \
    name: '佐山 果歩', password: '$K_SAYAMA_PASS', \
    password_confirmation: '$K_SAYAMA_PASS', \
    organization_id: Organizations::Organization.first.id, \
    skip_confirmation: true).execute"

# Start GitLab and keep the container running
sudo gitlab-ctl reconfigure
# sudo gitlab-ctl start
# tail -f /dev/null