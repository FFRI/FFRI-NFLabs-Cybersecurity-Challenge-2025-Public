#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <inttypes.h>

#define FLAG_PRICE 9999999


// 入力エラー時に標準入力バッファをクリア
void clear_input_buffer() {
    int ch;
    while ((ch = getchar()) != '\n' && ch != EOF);
}

int safe_scanf_int(const char *prompt, int32_t *out) {
    printf("%s", prompt);
    int result = scanf("%d", out);
    if (result != 1) {
        puts("Invalid input. Please enter a number.");
        clear_input_buffer();
        return 0;
    }
    clear_input_buffer(); 
    return 1;
}

void print_banner(void) {
    puts("=================================================");
    puts("      _____ _ _       _____ _                ");
    puts("     |  ___| (_)_ __ |  ___| | ___  _ __     ");
    puts("     | |_  | | | '_ \\| |_  | |/ _ \\| '_ \\    ");
    puts("     |  _| | | | |_) |  _| | | (_) | |_) |   ");
    puts("     |_|   |_|_| .__/|_|   |_|\\___/| .__/    ");
    puts("               |_|                 |_|       ");
    puts("                                              ");
    puts("           Welcome to Flip-Flop Shop!          ");
    puts("=================================================\n");
} 


void print_status_and_choice(int32_t money, int32_t yakusou_stock, int32_t sword_stock) {
    puts("\n+================= Player Status =================+");
    printf("| 💰 Gold: %-35" PRId32 "   |\n", money);
    puts("|                                                |");
    puts("| 🎒 Inventory:                                  |");
    printf("|   - Herb            x %-24d |\n", yakusou_stock);
    printf("|   - Legendary Sword x %-24d |\n", sword_stock);
    puts("+================================================+");
    puts("Choose an action:");
    puts(" 1. Buy");
    puts(" 2. Sell");
    puts(" 3. Exit\n");
}

int main() {
    int32_t money = 1000;  // Initial price
    int32_t yakusou_stock = 100;
    int32_t sword_stock = 1;
    int32_t choice, item, quantity;

    setbuf(stdout, NULL);
    setbuf(stdin, NULL);
    print_banner();


    while (1) {
        print_status_and_choice(money, yakusou_stock, sword_stock);
        
        if (!safe_scanf_int("> ", &choice)) continue;

        if (choice == 1) {
            puts("\n=== 🛍️ What would you like to buy? ===");
            puts(" 1. Torch - 10 yen");
            puts(" 2. Holy Water - 20 yen");
            puts(" 3. Great Stone - 800 yen");
            puts(" 4. FLAG - 9999999 yen \n");
            printf("Select an item to buy: ");
            scanf("%d", &item);

            int32_t price = 0;
            switch (item) {
                case 1: price = 10; break;
                case 2: price = 20; break;
                case 3: price = 800; break;
                case 4: price = FLAG_PRICE; break;
                default:
                    puts("Invalid selection. Please enter an integer!");
                    continue;
            }

            if (money >= price) {
                money -= price;
                if (item == 4) {
                    puts("🎉 Congratulations! Here is your flag:");
                    system("cat flag.txt");
                    break;
                } else {
                    puts("Item purchased.");
                }
            } else {
                puts("Not enough gold!!");
            }

        } else if (choice == 2) {
            puts("\n=== 🛒 What would you like to sell? ===");
            puts(" 1. Herb - 10 yen ");
            puts(" 2. Legendary Sword - 220000 yen \n");
            printf("Select an item to sell: ");
            if (!safe_scanf_int("> ", &item)) continue;

            int32_t unit_price = 0;
            int32_t *stock = NULL;
            const char *stock_name = NULL;

            switch (item) {
                case 1:
                    unit_price = 10;
                    stock = &yakusou_stock;
                    stock_name = "Herb";
                    break;
                case 2:
                    unit_price = 220000;
                    stock = &sword_stock;
                    stock_name = "Legendary Sword";
                    break;
                default:
                    puts("Invalid selection. Please enter an integer!");
                    continue;
            }

            printf("How many %s do you want to sell? (you have: %d): ", stock_name, *stock);
            if (!safe_scanf_int("> ", &quantity)) continue;

            if (quantity > 0 && quantity > *stock) {
                puts("You don't have enough items... ;(");
                continue;
            }
            // Integer overflow
            money += unit_price * quantity;

            if (stock && quantity > 0) {
                *stock -= quantity;
            }

            puts("Thank you :)");

        } else if (choice == 3) {
            puts("\nSee you again :)");
            break;

        } else {
            puts("Invalid command!!");
        }
    }

    return 0;
}