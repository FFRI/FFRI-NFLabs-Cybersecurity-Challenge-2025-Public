#!/bin/bash
set -euxo pipefail
cd "$(dirname "$0")"

readonly CHALLENGE_NAME='abnormal'

# 問題名のディレクトリへ、各種ファイルを配置します。
# ディレクトリが存在している場合も許容するため-pオプションを使用します。
mkdir -p "$CHALLENGE_NAME"
mkdir -p "$CHALLENGE_NAME/bin"

# ZIPファイル経由でのファイル名文字化けを避けるため、各種ファイル名はASCIIで命名します。
cp compose.yaml Dockerfile flag.txt "$CHALLENGE_NAME"
cp bin/abnormal "$CHALLENGE_NAME/bin"

# Flag を DUMM
sed -i 's/flag{[^}]*}/flag{this_is_a_test_flag}/g' "$CHALLENGE_NAME/flag.txt"

# 本問題の配布ファイルにはウイルス対策ソフトに検知されるようなファイルが無いため、パスワード無しでZIPを作成します。
# もし何らかの実行形式などウイルス対策ソフトに検知される可能性がある問題の場合は、 "CybersecurityChallenge" パスワードで暗号化してください。
zip -r "../dist/${CHALLENGE_NAME}.zip" "$CHALLENGE_NAME"

# 後片付けをします。
rm -rf "$CHALLENGE_NAME"

# 作成したZIPファイルを念のため確認します。
file "../dist/${CHALLENGE_NAME}.zip"
# 作成したZIPファイルのハッシュ値を、README.mdへ記述します。
sha256sum "../dist/${CHALLENGE_NAME}.zip"

echo 'done.'