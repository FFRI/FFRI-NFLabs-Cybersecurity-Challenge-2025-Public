#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <unistd.h>
#include <elf.h>

void dump_plt_memory(const uint8_t *p, size_t size, uintptr_t base_addr) {
    for (size_t i = 0; i < size; i++) {
        if (i % 16 == 0) printf("%08lx: ", base_addr + i);
        if (i % 16 == 2) printf("(");
        printf("%02x", p[i]);
        if (i % 16 == 5) {
            printf(") ");
        } else {
            printf(" ");
        }
        if (i % 16 == 15) printf("\n");
    }
    if (size % 16 != 0) printf("\n");
}

void dump_got_memory(const uint8_t *p, size_t size, uintptr_t base_addr) {
    for (size_t i = 0; i < size; i++) {
        if (i % 16 == 0) printf("%08lx: ", base_addr + i);
        if (i%16==0 || i%16==4 || i%16==8 || i%16==0xc) printf("(");
        printf("%02x", p[i]);
        if (i%16==3 || i%16==7 || i%16==0xb || i%16==0xf) {
            printf(") ");
        } else {
            printf(" ");
        }
        if (i % 16 == 15) printf("\n");
    }
    if (size % 16 != 0) printf("\n");
}

void dump_got_plt() {
    int fd = open("/proc/self/exe", O_RDONLY);
    if (fd < 0) {
        perror("open");
        return;
    }

    off_t file_size = lseek(fd, 0, SEEK_END);
    uint8_t *map = mmap(NULL, file_size, PROT_READ, MAP_PRIVATE, fd, 0);
    if (map == MAP_FAILED) {
        perror("mmap");
        close(fd);
        return;
    }

    Elf32_Ehdr *ehdr = (Elf32_Ehdr *)map;
    Elf32_Shdr *shdr = (Elf32_Shdr *)(map + ehdr->e_shoff);
    const char *shstrtab = (char *)(map + shdr[ehdr->e_shstrndx].sh_offset);

    uintptr_t plt_vaddr = 0;
    size_t plt_size = 0;
    uintptr_t got_vaddr = 0;
    size_t got_size = 0;

    for (int i = 0; i < ehdr->e_shnum; i++) {
        const char *name = shstrtab + shdr[i].sh_name;
        if (strcmp(name, ".plt") == 0) {
            plt_vaddr = shdr[i].sh_addr;
            plt_size = shdr[i].sh_size;
        }
        if (strcmp(name, ".got.plt") == 0) {
            got_vaddr = shdr[i].sh_addr;
            got_size = shdr[i].sh_size;
        }
    }

    munmap(map, file_size);
    close(fd);

    printf("This is my .plt section (virtual address: 0x%lx, size: 0x%lx)\n", plt_vaddr, plt_size);
    const uint8_t *plt_ptr = (const uint8_t *)plt_vaddr;
    dump_plt_memory(plt_ptr, plt_size, plt_vaddr);
    printf("\n");

    printf("This is my .got.plt section (virtual address: 0x%lx, size: 0x%lx)\n", got_vaddr, got_size);
    const uint8_t *got_ptr = (const uint8_t *)got_vaddr;
    dump_got_memory(got_ptr, got_size, got_vaddr);
    printf("\n");
}

void vuln() {
    char buf[4] = {0};
    printf("Name? ");
    gets(buf);
    printf("Nice to meet you, %s\n", buf);
}

void hints() {
    printf("I'll even show some function address!\n");
    printf("- munmap() addr is %lx\n", (void*)munmap);
    printf("- open() addr is %lx\n", (void*)open);
    printf("(Note: The above GOT dump is taken after these functions are called at least one time\n\n");
}

int main() {
    // GOT と PLT のダンプを表示(シンボルなし)
    dump_got_plt();
    // PLT の関数のアドレスを表示(シンボルが無いのでおまけとして)
    //  - バイナリにはシンボルはついていますが上記の表示でないので
    hints();
    
    puts("Now, let's exploit!");
    setvbuf(stdout, NULL, _IONBF, 0);
    vuln();
    return 0;
}
